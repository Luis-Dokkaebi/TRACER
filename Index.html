<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Holtmont V158 - ScriptMaster Edition</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    /* VARIABLES Y ESTILOS GLOBALES */
    :root { --sidebar-w: 260px; --sidebar-mini: 65px; --primary: #1c1c1c; --accent: #3699ff; --bg-body: #f3f6f9; }
    body { font-family: 'Roboto', sans-serif; background: var(--bg-body); margin: 0; overflow: hidden; font-size: 13px; }
    
    .content-wrapper { flex: 1; display: flex; flex-direction: column; background: var(--bg-body); overflow: hidden; position: relative; transition: margin-left 0.3s; }
    .view-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; padding: 20px; width: 100%; box-sizing: border-box; }

    /* TABLA EXCEL AVANZADA */
    .excel-container { 
        flex: 1; overflow: auto; background: white; border: 1px solid #999; 
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); width: 100%;
        scrollbar-width: thin; scrollbar-color: #a0a0a0 #f1f1f1;
    }
    .excel-container::-webkit-scrollbar { height: 14px; width: 14px; }
    .excel-container::-webkit-scrollbar-track { background: #f1f1f1; }
    .excel-container::-webkit-scrollbar-thumb { background: #888; border-radius: 7px; border: 3px solid #f1f1f1; }
    .excel-container::-webkit-scrollbar-thumb:hover { background: #555; }

    .table-excel { width: max-content; min-width: 100%; border-collapse: collapse; background-color: #fff; table-layout: fixed; }
    .table-excel th { 
        background-color: #e6e6e6; color: #000; font-weight: 700; text-align: center; 
        border: 1px solid #999; padding: 8px 4px; font-size: 12px; 
        position: sticky; top: 0; z-index: 20; white-space: nowrap; box-shadow: 0 1px 0 #999; 
    }
    .table-excel td { border: 1px solid #b2b2b2 !important; padding: 0; margin: 0; height: 30px; vertical-align: middle; position: relative; } 
    
    .excel-input { 
        width: 100%; min-height: 28px; height: 100%; border: none; padding: 4px 6px; outline: none; 
        font-size: 12px; background: transparent; display: block; font-family: inherit; 
        line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: clip; 
    }
    .excel-input:focus { outline: 2px solid #107c41; outline-offset: -2px; z-index: 2; position: relative; background: white; }
    .input-row { background-color: #f8f9fa; border-bottom: 2px solid #107c41; } 
    .row-num { background-color: #e6e6e6; text-align: center; color: #333; font-weight: bold; width: 40px; border-right: 3px solid #ccc !important; }

    /* MINI DASHBOARD & KPI */
    .mini-table { width: auto !important; min-width: 0 !important; border: none; }
    .mini-table th { padding: 5px 6px; font-size: 11px; height: auto; line-height: 1.2; border: 1px solid #999; text-align: center; white-space: nowrap; background-color: #e6e6e6; }
    .mini-table td { height: auto; font-size: 11px; padding: 4px 6px; line-height: 1.2; border: 1px solid #ccc; }
    .mini-table .total-row td { background-color: #333; color: white; font-weight: bold; border-top: 2px solid #555 !important; }

    /* DYNAMIC TRACKER FORM */
    .dynamic-tracker { background-color: #f4f6f8 !important; color: #333; flex:1; display:flex; flex-direction:column; padding:0 !important; overflow-y:auto; }
    .dynamic-form-card { background: #ffffff; border: 1px solid #dfe3e8; border-radius: 8px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); max-width: 960px; width: 100%; margin: 0 auto; }
    .dynamic-input { background: #ffffff; border: 1px solid #ced4da; color: #333; padding: 8px 12px; border-radius: 4px; width: 100%; font-size: 13px; transition: border-color 0.2s; }
    .dynamic-input:focus { outline: none; border-color: #e83e8c; box-shadow: 0 0 0 2px rgba(232, 62, 140, 0.1); }
    .dynamic-label { font-size: 11px; font-weight: 700; color: #637381; margin-bottom: 6px; display: block; text-transform: uppercase; letter-spacing: 0.5px; }
    .chip-option { cursor: pointer; padding: 6px 14px; border-radius: 15px; background: #f1f3f5; border: 1px solid #dee2e6; color: #495057; font-size: 11px; margin-right: 6px; display: inline-block; transition: all 0.2s; font-weight: 500; }
    .chip-option:hover { background: #e9ecef; border-color: #ced4da; }
    .chip-option.selected { background: #e83e8c; color: white; border-color: #e83e8c; box-shadow: 0 2px 5px rgba(232, 62, 140, 0.3); }

    /* LAYOUT & SIDEBAR */
    .app-wrapper { display: flex; height: 100vh; width: 100vw; }
    .sidebar { width: var(--sidebar-w); background: var(--primary); color: #a2a3b7; display: flex; flex-direction: column; transition: width 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); position: relative; z-index: 1050; white-space: nowrap; overflow: hidden; flex-shrink: 0; }
    .sidebar.compact { width: var(--sidebar-mini); }
    .sidebar.compact:hover { width: var(--sidebar-w); box-shadow: 5px 0 15px rgba(0,0,0,0.3); }

    .brand { height: 70px; display: flex; align-items: center; padding: 0 20px; font-weight: bold; color: white; justify-content: space-between; }
    .menu { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 20px 0; }
    .nav-item { padding: 12px 20px; cursor: pointer; display: flex; align-items: center; color: #a2a3b7; transition: 0.2s; height: 45px; }
    .nav-item:hover { color: white; background: rgba(255,255,255,0.03); }
    .nav-item.active { background: #1b1b29; color: var(--accent); } 
    .nav-icon-col { width: 25px; text-align: center; margin-right: 15px; display: flex; justify-content: center; }
    .nav-text { transition: opacity 0.2s; opacity: 1; }
    .sidebar.compact:not(:hover) .nav-text, .sidebar.compact:not(:hover) .brand-text, .sidebar.compact:not(:hover) .section-title { opacity: 0; pointer-events: none; display: none; }
    .sidebar.compact:not(:hover) .nav-item { padding: 12px 0; justify-content: center; }
    .sidebar.compact:not(:hover) .nav-icon-col { margin-right: 0; }
    .sidebar.compact:not(:hover) .brand { justify-content: center; padding: 0; }
    .sidebar.compact:not(:hover) .btn-toggle-sidebar { margin: 0; }
    .section-title { padding: 15px 20px 5px; font-size: 0.7rem; color: #555; font-weight: bold; white-space: nowrap; }
    .top-bar { height: 70px; background: white; border-bottom: 1px solid #eff2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; }
    
    /* COMPONENTES */
    .login-overlay { position: fixed; inset: 0; background: var(--primary); z-index: 2000; display: flex; align-items: center; justify-content: center; }
    .login-card { background: #1c1c1c; padding: 40px; border-radius: 15px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); color: #eee; position: relative; overflow: hidden; }
    .login-logo { max-width: 85%; height: auto; margin-bottom: 25px; mask-image: radial-gradient(ellipse at center, black 40%, transparent 100%); }
    .dept-card, .staff-card { background: white; border-radius: 12px; box-shadow: 0 0 20px 0 rgba(0,0,0,0.03); padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; }
    .dept-card:hover, .staff-card:hover { transform: translateY(-5px); border-color: var(--accent); }
    .chip-container { border: 1px solid #ccc; background: white; padding: 2px; display: flex; flex-wrap: wrap; gap: 2px; min-height: 100%; align-items: center; }
    .user-chip { background: #e8f0fe; border: 1px solid #d2e3fc; border-radius: 4px; padding: 0 4px; font-size: 11px; display: flex; align-items: center; gap: 4px; white-space: nowrap; }
    .file-input-hidden { display: none; } 
    .btn-attach { border: 1px solid #ccc; background: #f8f9fa; color: #666; padding: 4px 10px; font-size: 12px; border-radius: 4px; cursor: pointer; }
    .btn-attach.has-file { background: #d4edda; color: #155724; border-color: #c3e6cb; }
    .iframe-container { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; flex-direction: column; }
    .iframe-toolbar { height: 45px; background: #333; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
    iframe { flex: 1; width: 100%; border: none; }
    
    /* MODAL */
    .custom-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1050; display: flex; align-items: center; justify-content: center; }
    .custom-modal { background: white; width: 400px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); overflow: hidden; }
    .custom-modal-header { background: #f8f9fa; padding: 15px; border-bottom: 1px solid #dee2e6; font-weight: bold; display: flex; justify-content: space-between; }
    .custom-modal-body { padding: 20px; }
    .custom-modal-footer { padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: right; }
    .chip-select { cursor: pointer; padding: 6px 12px; border-radius: 20px; background: #f1f3f5; color: #495057; font-size: 11px; margin-right: 5px; margin-bottom: 5px; display: inline-block; border: 1px solid #dee2e6; transition: 0.2s; font-weight: 500; }
    .chip-select.active { background: #3699ff; color: white; border-color: #3699ff; box-shadow: 0 2px 5px rgba(54, 153, 255, 0.3); }

    /* ESTILOS CASCADA PROYECTOS */
    .cascade-container { background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); overflow: hidden; }
    .cascade-item { cursor: pointer; transition: all 0.2s; border-bottom: 1px solid #f0f2f5; position: relative; }
    .cascade-item:hover { background-color: #f8faff; }
    .cascade-header { padding: 15px 20px; background: #fff; font-weight: 600; color: #343a40; display: flex; align-items: center; border-left: 4px solid transparent; }
    .cascade-header:hover { border-left-color: var(--accent); }
    .cascade-header.expanded .expand-icon { transform: rotate(90deg); color: var(--accent); }
    .cascade-children { display: none; background-color: #fcfdfe; position: relative; }
    .cascade-children.show { display: block; animation: fadeIn 0.3s ease; }
    .cascade-children::before { content: ''; position: absolute; top: 0; bottom: 15px; left: 28px; width: 2px; background-color: #e9ecef; z-index: 1; }
    .cascade-subitem { padding: 12px 20px 12px 50px; display: flex; align-items: center; font-weight: 500; color: #495057; position: relative; z-index: 2; }
    .cascade-folder { padding: 10px 20px 10px 85px; display: flex; align-items: center; color: #6c757d; font-size: 12px; position: relative; z-index: 2; transition: 0.2s; }
    .project-type-option { padding: 10px; border: 1px solid #dee2e6; border-radius: 8px; text-align: center; cursor: pointer; transition: 0.2s; flex: 1; }
    .project-type-option.selected { background: #e7f1ff; border-color: #0d6efd; color: #0d6efd; font-weight: bold; }

    /* --- ESTILOS ECG MONITOR --- */
    .ecg-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; height: 100%; overflow-y: auto; padding-right: 5px; }
    .ecg-card { background-color: #000; border: 1px solid #333; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: relative; box-shadow: 0 0 15px rgba(0, 255, 0, 0.1); }
    .ecg-card::before { content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; width: 100%; background: linear-gradient(90deg, transparent, rgba(0, 255, 0, 0.1) 50%, transparent); pointer-events: none; z-index: 1; animation: scan 4s linear infinite; }
    .ecg-header { background: #111; padding: 10px 15px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; }
    .ecg-title { color: #0f0; font-family: 'Share Tech Mono', monospace; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; text-shadow: 0 0 5px #0f0; }
    .ecg-stats { font-family: 'Share Tech Mono', monospace; color: #aaa; font-size: 11px; }
    .ecg-canvas-container { flex: 1; position: relative; min-height: 200px; background: #050505; }
    .ecg-canvas-container::after { content: ""; position: absolute; top:0; left:0; right:0; bottom:0; background-image: linear-gradient(rgba(0, 50, 0, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 50, 0, 0.3) 1px, transparent 1px); background-size: 20px 20px; pointer-events: none; }
    @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
  </style>
</head>
<body>

<div id="app">
  <div v-if="!isLoggedIn" class="login-overlay">
    <div class="login-card">
      <img src="https://drive.google.com/thumbnail?id=1tmNuwauWNjOhv0JwX6ug9pzvsrBCNX7z&sz=w1000" class="login-logo" alt="Logo">
      <h3 class="fw-bold mb-4">BIENVENIDO</h3>
      <p class="text-muted mb-4">Acceso Seguro</p>
      <div class="mb-3">
          <input type="text" v-model="loginUser" class="form-control text-center mb-2" placeholder="Usuario">
          <div class="input-group">
              <input :type="showPassword ? 'text' : 'password'" v-model="loginPass" class="form-control text-center" placeholder="Contraseña..." @keyup.enter="doLogin">
              <button class="btn btn-light border" type="button" @click="showPassword = !showPassword" title="Mostrar/Ocultar">
                  <i class="fas" :class="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
              </button>
          </div>
      </div>
      <button class="btn btn-success w-100 fw-bold" @click="doLogin" :disabled="loggingIn">
        <span v-if="loggingIn">Conectando...</span><span v-else>INICIAR SESIÓN</span>
      </button>
    </div>
  </div>

  <div v-if="isLoggedIn" class="app-wrapper">
    <aside class="sidebar" :class="{ compact: isCompact }">
      <div class="brand">
          <span class="brand-text"><i class="fas fa-table me-2 text-primary"></i> HOLTMONT</span>
          <button class="btn btn-sm btn-link text-secondary btn-toggle-sidebar" @click="toggleSidebar" title="Contraer/Expandir Menú">
              <i class="fas fa-bars"></i>
          </button>
      </div>
      <div class="menu">
        <div class="nav-item" :class="{ active: currentView === 'DASHBOARD' }" @click="goHome">
            <div class="nav-icon-col"><i class="fas fa-th"></i></div>
            <span class="nav-text">Dashboard</span>
        </div>
        
        <div class="nav-item" v-if="config.accessProjects" :class="{ active: currentView === 'PROJECTS' }" @click="currentView = 'PROJECTS'; currentDept = ''; currentModuleId = '';">
            <div class="nav-icon-col"><i class="fas fa-project-diagram"></i></div>
            <span class="nav-text">Proyectos</span>
        </div>
        
        <div v-if="config.specialModules.length">
            <div class="section-title">ACCIONES</div>
            <div class="nav-item" v-for="m in config.specialModules" @click="openModule(m)" :class="{ active: currentModuleId === m.id }" :style="{ borderRight: currentModuleId === m.id ? '3px solid ' + m.color : '3px solid transparent' }">
                <div class="nav-icon-col"><i class="fas" :class="m.icon" :style="{color: m.color}"></i></div>
                <span class="nav-text" :style="{ color: currentModuleId === m.id ? 'white' : '#a2a3b7' }">{{m.label}}</span>
            </div>
        </div>

        <div v-if="Object.keys(config.departments).length">
            <div class="section-title">ÁREAS</div>
            <div class="nav-item" v-for="(d,k) in config.departments" @click="selectDept(k)" :class="{ active: currentDept === k }" :style="{ borderRight: currentDept === k ? '3px solid ' + d.color : '3px solid transparent' }">
                <div class="nav-icon-col"><i class="fas" :class="d.icon" :style="{ color: d.color }"></i></div>
                <span class="nav-text" :style="{ color: currentDept === k ? 'white' : '#a2a3b7' }">{{d.label}}</span>
            </div>
        </div>

        <div class="mt-auto">
            <div class="p-3">
                <button class="btn btn-outline-secondary w-100 btn-sm" @click="logout" :title="isCompact ? 'Salir' : ''">
                    <i class="fas fa-sign-out-alt" v-if="isCompact"></i>
                    <span v-else>Salir</span>
                </button>
            </div>
        </div>
      </div>
    </aside>

    <main class="content-wrapper">
      <div class="top-bar">
        <h6 class="m-0 fw-bold text-secondary">{{ pageTitle }}</h6>
        <span class="badge bg-light text-dark border">{{ currentUser }}</span>
      </div>

      <div class="view-area" v-if="!['IFRAME', 'MODULE_TABS'].includes(currentView)">
        
        <div v-if="currentView === 'DASHBOARD'" class="row g-3">
          <div class="col-md-4 col-lg-3" v-for="mod in config.specialModules" :key="mod.id">
            <div class="dept-card" @click="openModule(mod)" :style="{borderTop: '4px solid '+mod.color}">
                <i class="fas fa-2x mb-3" :class="mod.icon" :style="{color: mod.color}"></i>
                <h6 class="fw-bold" :style="{color: mod.color}">{{mod.label}}</h6>
            </div>
          </div>
          <div class="col-md-4 col-lg-3" v-for="(dept, key) in config.departments" :key="key">
            <div class="dept-card" @click="selectDept(key)" :style="{borderTop: '4px solid '+dept.color}">
                <i class="fas fa-2x mb-3" :class="dept.icon" :style="{color: dept.color}"></i>
                <h6 class="fw-bold" :style="{color: dept.color}">{{dept.label}}</h6>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'KPI_DASHBOARD'" class="h-100 d-flex flex-column" style="background-color:#f8f9fa; padding:20px;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                 <h4 class="fw-bold m-0 text-dark"><i class="fas fa-chart-pie me-2 text-danger"></i>KPI RENDIMIENTO - VISTA EXCLUSIVA</h4>
                 <div>
                    <button class="btn btn-outline-primary btn-sm me-2" @click="loadKPIData"><i class="fas fa-sync-alt"></i> ACTUALIZAR</button>
                    <button class="btn btn-secondary btn-sm" @click="goHome">CERRAR</button>
                 </div>
            </div>

            <div v-if="kpiData.isLoading" class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div>
            </div>

            <div v-else class="row g-4 h-100 overflow-auto">
                <!-- PANEL ANTONIA (NEW) -->
                <div class="col-12" v-if="kpiData.antonia">
                    <div class="card shadow-sm border-0 h-100">
                         <div class="card-header bg-white border-bottom fw-bold text-uppercase" style="color:#0dcaf0">
                             <i class="fas fa-chart-bar me-2"></i>PRODUCTIVIDAD DIARIA: ANTONIA
                         </div>
                         <div class="card-body">
                             <div style="height: 300px;">
                                 <canvas id="kpiChartAntonia"></canvas>
                             </div>
                         </div>
                    </div>
                </div>

                <!-- PANEL VENTAS -->
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-bottom fw-bold text-uppercase" style="color:#2c3e50">
                            <i class="fas fa-hand-holding-usd me-2"></i>DASHBOARD VENTAS
                        </div>
                        <div class="card-body row">
                            <div class="col-md-5">
                                <table class="table table-bordered table-sm small">
                                    <thead class="table-light"><tr><th>Colaborador</th><th class="text-center">Volumen</th><th class="text-center">Eficiencia (Días)</th></tr></thead>
                                    <tbody>
                                        <tr v-for="user in kpiData.ventas" :key="user.name">
                                            <td class="fw-bold">{{ user.name }}</td>
                                            <td class="text-center">{{ user.volume }}</td>
                                            <td class="text-center text-primary fw-bold">{{ user.efficiency }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-7" style="height: 300px;">
                                <canvas id="kpiChartVentas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PANEL TRACKER -->
                <div class="col-12">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-header bg-white border-bottom fw-bold text-uppercase" style="color:#e74c3c">
                            <i class="fas fa-tasks me-2"></i>DASHBOARD TRACKER
                        </div>
                        <div class="card-body row">
                            <div class="col-md-5">
                                <table class="table table-bordered table-sm small">
                                    <thead class="table-light"><tr><th>Colaborador</th><th class="text-center">Volumen</th><th class="text-center">Eficiencia (Días)</th></tr></thead>
                                    <tbody>
                                        <tr v-for="user in kpiData.tracker" :key="user.name">
                                            <td class="fw-bold">{{ user.name }}</td>
                                            <td class="text-center">{{ user.volume }}</td>
                                            <td class="text-center text-danger fw-bold">{{ user.efficiency }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-7" style="height: 300px;">
                                <canvas id="kpiChartTracker"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'ECG_VIEW'" class="h-100 d-flex flex-column" style="background-color:#000; margin:-20px; padding:20px;">
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom border-secondary pb-2">
                <div class="d-flex align-items-center">
                    <i class="fas fa-heartbeat fa-2x me-3" style="color:#d63384"></i>
                    <h4 class="text-white m-0" style="font-family:'Share Tech Mono'">MONITOR VIVOS: SEÑAL DE VENTAS</h4>
                </div>
                <div>
                    <button class="btn btn-outline-success btn-sm me-2" @click="loadEcgData"><i class="fas fa-sync-alt"></i> REFRESCAR</button>
                    <button class="btn btn-outline-secondary btn-sm" @click="goHome">CERRAR</button>
                </div>
            </div>
            
            <div class="ecg-grid">
                <div v-for="(data, personName) in ecgData" :key="personName" class="ecg-card">
                    <div class="ecg-header">
                        <div class="ecg-title">{{ personName }}</div>
                        <div class="ecg-stats">
                            <span class="me-2 text-white">TOTAL: {{ data.length }}</span>
                            <span class="text-success">VIVO</span>
                        </div>
                    </div>
                    <div class="ecg-canvas-container">
                        <canvas :id="'chart-'+personName.replace(/\s+/g,'')"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="currentView === 'PROJECTS'" class="animate__animated animate__fadeIn h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-4">
              <div class="d-flex align-items-center">
                  <h4 class="fw-bold text-secondary m-0"><i class="fas fa-briefcase me-2"></i>EXPLORADOR DE PROYECTOS</h4>
                  <button class="btn btn-outline-secondary btn-sm ms-3" @click="loadCascadeTree" title="Recargar Lista"><i class="fas fa-sync-alt"></i></button>
              </div>
              <div>
                   <button class="btn btn-success btn-sm fw-bold shadow-sm me-2" @click="openPpcProjectSelector">
                      <i class="fas fa-plus me-1"></i> NUEVO SITIO
                  </button>
                  <button class="btn btn-outline-secondary btn-sm" @click="goHome">Cerrar</button>
              </div>
          </div>
          <div class="cascade-container flex-fill overflow-auto">
              <div v-for="site in activeProjectsList" :key="site.id" class="cascade-item-wrapper">
                  <div class="cascade-item cascade-header" :class="{expanded: site.expanded}" @click="toggleExpand(site)">
                      <i class="expand-icon fas fa-chevron-right"></i>
                      <i class="fas fa-building text-primary me-2 opacity-75"></i>
                      <div class="d-flex flex-column flex-grow-1">
                          <span class="fw-bold">{{ site.name }}</span>
                          <span class="small text-muted" style="font-size:0.75rem">{{ site.createdAt }}</span>
                      </div>
                      <span class="ms-2 badge bg-light text-muted border">{{ site.client }}</span>
                      <button class="btn btn-sm btn-link text-success ms-auto p-0" @click.stop="openAddSubProject(site)" title="Crear Subcarpeta"><i class="fas fa-plus-circle fa-lg"></i></button>
                  </div>
                  <div class="cascade-children" :class="{show: site.expanded}">
                      <div v-for="(sub, sIdx) in site.subProjects" :key="sIdx" class="cascade-item-wrapper">
                          <div class="cascade-item cascade-subitem" :class="{expanded: sub.expanded}" @click="toggleExpand(sub)">
                              <i class="expand-icon fas fa-chevron-right"></i>
                              <i class="project-icon fas" :class="sub.icon || 'fa-clipboard-list'"></i>
                              <span class="flex-grow-1">{{ sub.name }}</span>
                              <small class="ms-2 text-muted me-2">({{ sub.type }})</small>
                              <button class="btn btn-sm btn-outline-primary py-0 px-2 border-0" @click.stop="openProjectTask(sub)" title="Asignar Tarea a este Proyecto"><i class="fas fa-clipboard-check"></i></button>
                          </div>
                          <div class="cascade-children" :class="{show: sub.expanded}">
                               <div v-for="(folder, fIdx) in projectSubFolders" :key="fIdx" 
                                    class="cascade-item cascade-folder" 
                                    @click.stop="openFolderContent(folder, sub.name)">
                                   <i class="fas" :class="folder.icon" :style="{color: folder.color}"></i>
                                   <span>{{ folder.name }}</span>
                               </div>
                          </div>
                      </div>
                      <div v-if="!site.subProjects || site.subProjects.length === 0" class="text-muted small p-3 ps-5 ms-4 fst-italic">No hay proyectos.</div>
                  </div>
              </div>
          </div>
        </div>

        <div v-if="currentView === 'PROJECT_TASKS_VIEW'" class="h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border rounded">
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm border me-2" @click="currentView = 'PROJECTS'"><i class="fas fa-arrow-left"></i></button>
                <div class="d-flex flex-column">
                    <span class="small fw-bold text-muted">ACTIVIDADES DEL PROYECTO:</span>
                    <span class="fw-bold text-primary">{{ currentPpcProject ? currentPpcProject.name : '' }}</span>
                </div>
            </div>
            <div>
                 <button class="btn btn-primary btn-sm me-2" @click="refreshProjectTasks"><i class="fas fa-sync-alt"></i></button>
                 <button class="btn btn-success btn-sm fw-bold" @click="addNewProjectTask"><i class="fas fa-plus"></i> NUEVA ACTIVIDAD</button>
            </div>
          </div>
          <div class="excel-container flex-fill">
             <div v-if="projectTasks.isLoading" class="text-center p-5 text-muted">Cargando actividades...</div>
             <div v-else-if="projectTasks.data.length === 0" class="text-center p-5 text-muted fst-italic">No hay actividades registradas para este proyecto.</div>
             <table v-else class="table-excel">
                <thead>
                  <tr>
                    <th class="row-num">#</th>
                    <th v-for="(h, idx) in projectTasks.headers" :key="idx" :style="getColumnStyle(h)">{{ getHeaderLabel(h) }}</th>
                    <th style="width:40px"><i class="fas fa-save"></i></th>
                  </tr>
                </thead>
                <tbody>
                   <tr v-for="(row, i) in projectTasks.data" :key="i" :class="{'new-row-highlight': row._isNew}">
                      <td class="row-num">{{i+1}}</td>
                      <td v-for="(h, idx) in projectTasks.headers" :key="idx">
                         <div v-if="isCol(h, ['AREA','ALTA'])" style="position:relative; width:100%; height:100%;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-weight:bold; font-size:12px;">{{ row[h] ? String(row[h]).charAt(0).toUpperCase() : '' }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option v-for="(dept, k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{dept.label}}</option></select>
                         </div>
                         <input v-else-if="isCol(h, ['ESTATUS','STATUS'])" v-model="row[h]" class="excel-input" style="font-weight:bold">
                         <input v-else v-model="row[h]" class="excel-input">
                      </td>
                      <td class="text-center" style="background:#f8f9fa"><button class="btn btn-link btn-sm p-0 text-success" @click="saveProjectRow(row)"><i class="fas fa-save"></i></button></td>
                   </tr>
                </tbody>
             </table>
          </div>
        </div>

        <div v-if="currentView === 'DEPT'">
          <div class="d-flex justify-content-between mb-3"><button class="btn btn-light btn-sm border" @click="goHome">Atrás</button><input v-model="searchQuery" class="form-control form-control-sm w-auto" placeholder="Filtrar..."></div>
          <div class="row g-2">
            <div class="col-md-3" v-for="p in filteredStaff" :key="p.name">
              <div class="staff-card h-100" @click="openStaffTracker(p)" :style="{borderTop: '4px solid ' + (currentDeptData.color || '#3699ff')}">
                <div class="mb-2 fw-bold" :style="{color: currentDeptData.color || '#555'}" style="font-size:1.2rem">{{p.name.charAt(0)}}</div>
                <div class="small fw-bold">{{p.name}}</div>
              </div>
            </div>
          </div>
        </div>

        <div v-if="currentView === 'STAFF_TRACKER'" class="h-100 d-flex flex-column">
          <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border rounded">
            <div class="d-flex align-items-center">
                <button class="btn btn-light btn-sm border me-2" @click="goBackToDept"><i class="fas fa-arrow-left"></i></button>
                <span class="small fw-bold me-2" :style="{color: currentDeptData.color || 'var(--primary)'}"><i class="fas fa-file-excel me-1"></i> {{ staffTracker.name }}</span>
                <button class="btn btn-primary btn-sm py-0 px-2 me-1" @click="reloadStaffTracker" title="Actualizar"><i class="fas fa-sync-alt me-1"></i> Actualizar</button>
                <button class="btn btn-success btn-sm py-0 px-2" @click="addNewRow" title="Agregar"><i class="fas fa-plus me-1"></i> Fila</button>
            </div>
            <div></div>
          </div>
          <div class="excel-container flex-fill mb-2">
             <div v-if="staffTracker.isLoading" class="text-center p-5 text-muted">Cargando datos...</div>
             <table v-else class="table-excel">
                <thead>
                  <tr>
                    <th class="row-num">#</th>
                    <th v-for="(h, idx) in staffTracker.headers" :key="idx" :style="getColumnStyle(h)">{{ getHeaderLabel(h) }}</th>
                    <th style="width:40px"><i class="fas fa-save"></i></th>
                  </tr>
                </thead>
                <tbody>
                   <tr v-for="(row, i) in staffTracker.data" :key="i" :class="{'new-row-highlight': row._isNew}">
                      <td class="row-num">{{i+1}}</td>
                      <td v-for="(h, idx) in staffTracker.headers" :key="idx">
                         <div v-if="isCol(h, ['AREA','ALTA','ESPECIALIDAD'])" style="position:relative; width:100%; height:100%;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-weight:bold; font-size:12px;">{{ row[h] ? String(row[h]).charAt(0).toUpperCase() : '' }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option v-for="(dept, k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{dept.label}}</option></select>
                         </div>
                         <div v-else-if="String(h).toUpperCase().includes('VENDEDOR')" style="position:relative; width:100%; height:100%; background-color:#f0fdf4;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-size:11px; white-space:nowrap; overflow:hidden;">{{ toInitials(row[h]) }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;">
                                 <option value="">-</option>
                                 <option v-for="s in salesStaff" :key="s" :value="s">{{s}}</option>
                             </select>
                         </div>
                         <div v-else-if="isMediaColumn(h)" class="text-center" style="padding-top:4px; display:flex; gap:2px; flex-wrap:wrap; justify-content:center; align-items:center; height:100%;">
                             <template v-if="row[h]">
                                 <a v-for="(url, uIdx) in String(row[h]).split(/[\n\s]+/).filter(u => u.startsWith('http'))" :key="uIdx" :href="url" target="_blank" class="btn btn-sm btn-outline-primary py-0 px-1" style="font-size:9px; margin-right:1px;" title="Ver archivo"><i class="fas fa-paperclip"></i></a>
                             </template>
                             <button class="btn btn-sm btn-light border py-0 px-1 text-secondary" @click="openCellUpload(row, h)" title="Subir archivo"><i class="fas fa-cloud-upload-alt" style="font-size:10px"></i></button>
                         </div>
                         <div v-else-if="isCol(h, ['CLASIFICACION'])" style="position:relative; width:100%; height:100%;">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; font-size:10px; font-weight:bold;">{{ row[h] }}</div>
                             <select v-model="row[h]" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;"><option value="">-</option><option value="A">A</option><option value="AA">AA</option><option value="AAA">AAA</option></select>
                         </div>
                         <input v-else-if="isCol(h, ['DIAS','RELOJ'])" v-model="row[h]" style="text-align:center; font-weight:bold; width:100%; height:100%; border:none; outline:none; padding:6px 0px; background:transparent;" :style="getTrafficStyle(row)">
                         <input v-else-if="String(h).toUpperCase().includes('AVANCE')" v-model="row[h]" style="text-align:center; font-weight:bold; color:#217346; width:100%; height:100%; border:none; outline:none; padding:6px 0px; background:transparent;">
                         <input v-else-if="isCol(h, ['ESTATUS','STATUS'])" v-model="row[h]" style="text-align:center; font-weight:bold; font-size:10px; width:100%; height:100%; border:none; outline:none; padding:6px 1px; background:transparent;" class="excel-input">
                         <div v-else-if="isCol(h, ['REQUISITOR'])" class="d-flex" style="height:100%; width:100%; align-items:center;">
                             <input v-model="row[h]" class="excel-input" style="flex:1; min-width:0;" spellcheck="false">
                         </div>
                         <div v-else-if="String(h).toUpperCase().includes('FECHA')" style="position:relative; width:100%; height:100%;" :style="isCol(h, ['FECHA RESPUESTA', 'FECHA DE RESPUESTA', 'FEC. EST. FIN', 'FECHA ESTIMADA DE FIN', 'FECHA DE ENTREGA']) ? getFechaRespuestaStyle(row) : {}">
                             <div style="position:absolute; inset:0; display:flex; align-items:center; padding-left:4px; font-size:12px; pointer-events:none;">{{ formatDisplayDate(row[h]) }}</div>
                             <input type="date" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;" :value="toIsoDate(row[h])" @input="updateDateFromPicker($event, row, h)">
                         </div>
                         <input v-else v-model="row[h]" class="excel-input" spellcheck="false">
                      </td>
                      <td class="text-center" style="background:#f8f9fa"><button class="btn btn-link btn-sm p-0 text-success" @click="saveRow(row)"><i class="fas fa-save"></i></button></td>
                   </tr>
                </tbody>
             </table>
          </div>
          <div class="excel-container flex-fill" v-if="staffTracker.history.length" style="max-height:30%">
             <div class="sticky-top bg-light border-bottom px-2 small fw-bold text-muted">HISTORIAL</div>
             <table class="table-excel"><tbody><tr v-for="(row, i) in staffTracker.history" :key="i"><td class="row-num">H{{i+1}}</td><td v-for="(h, idx) in staffTracker.headers" :key="idx" :style="getColumnStyle(h)">{{row[h]}}</td><td style="width:40px;text-align:center"><i class="fas fa-check text-muted small"></i></td></tr></tbody></table>
          </div>
        </div>

        <div v-if="currentView === 'WEEKLY_PLAN'" class="h-100 d-flex flex-column" style="background:white; padding:20px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex align-items-center gap-2">
                    <h5 class="m-0 text-primary fw-bold me-2"><i class="fas fa-calendar-week me-2"></i>PPCV3</h5>
                    <select v-model="selectedWeek" class="form-select form-select-sm border-primary" style="width: auto; font-weight: bold;">
                        <option value="">VER TODAS LAS SEMANAS</option>
                        <option v-for="w in availableWeeks" :key="w" :value="w">Semana {{ w }}</option>
                    </select>
                    <select v-model="filterSpecialty" class="form-select form-select-sm border-secondary" style="width: auto;">
                        <option value="">TODAS LAS ÁREAS</option>
                        <option v-for="sp in availableSpecialties" :key="sp" :value="sp">{{ sp }}</option>
                    </select>
                    <select v-model="filterCompliance" class="form-select form-select-sm border-secondary" style="width: auto;">
                        <option value="">CUMPLIMIENTO (TODOS)</option>
                        <option value="SI">CUMPLIDO (SI)</option>
                        <option value="NO">NO CUMPLIDO (NO)</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" @click="loadWeeklyPlan" title="Recargar"><i class="fas fa-sync-alt"></i></button>
                    <button class="btn btn-light border btn-sm" @click="goHome">Cerrar</button>
                </div>
            </div>
            <div class="d-flex mb-3 align-items-end justify-content-start">
            <div class="excel-container" style="height: auto; max-height: 250px; overflow: auto; flex:none; width: fit-content; border:none; box-shadow:none;">
                <table class="table-excel mini-table" style="background: white; border: 1px solid #999;"> 
                    <thead><tr><th style="min-width:140px">ESPECIALIDAD</th><th style="width:50px">TOTAL</th><th style="width:50px" class="bg-success text-white">SI</th><th style="width:50px" class="bg-danger text-white">NO</th><th style="width:70px">PROMEDIO</th></tr></thead>
                    <tbody><tr v-for="(s, i) in weeklyStats" :key="i" :class="{'total-row': s.isTotal}"><td class="text-start ps-2 fw-bold" style="font-size:11px">{{ s.label }}</td><td class="text-center">{{ s.total }}</td><td class="text-center text-success fw-bold">{{ s.si }}</td><td class="text-center text-danger">{{ s.no }}</td><td class="text-center fw-bold text-primary">{{ s.avg }}</td></tr></tbody>
                </table>
            </div>
            </div>
            <div class="excel-container flex-fill">
                <div v-if="weeklyPlanData.isLoading" class="text-center p-5 text-muted"><div class="spinner-border text-primary mb-2" role="status"></div><div>Cargando datos...</div></div>
                <table v-else class="table-excel">
                    <thead>
                      <tr>
                        <th class="row-num">#</th>
                        <th v-for="(h, idx) in weeklyPlanData.headers" :key="idx" :style="getColumnStyle(h)">{{ getHeaderLabel(h) }}</th>
                        <th style="width:40px"><i class="fas fa-save"></i></th>
                      </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(row, i) in filteredWeeklyData" :key="i">
                            <td class="row-num">{{ i + 1 }}</td>
                            <td v-for="(h, idx) in weeklyPlanData.headers" :key="idx" class="text-center">
                                <div v-if="h === 'SEMANA'" style="font-weight:bold; color:#0d6efd; background-color:#f8f9fa; font-size:10px;">S{{ row[h] }}</div>
                                <div v-else-if="h.includes('CUMPLIMIENTO')" style="position:relative; width:100%; height:100%;">
                                    <div style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none; z-index:1;"><span class="badge rounded-pill" :class="String(row[h]).toUpperCase() === 'SI' ? 'bg-success' : 'bg-danger'" style="font-size:10px; width:40px; box-shadow: 0 1px 2px rgba(0,0,0,0.1);">{{ row[h] || 'NO' }}</span></div>
                                    <select v-model="row[h]" @change="savePPCV3Row(row)" style="position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; z-index:10;"><option value="SI">SI</option><option value="NO">NO</option></select>
                                </div>
                                <div v-else-if="h.includes('ARCHIVO') || h.includes('CLIP')"><a v-if="row[h]" :href="row[h]" target="_blank" class="btn btn-sm text-primary"><i class="fas fa-paperclip"></i></a></div>
                                <div v-else-if="String(h).toUpperCase().includes('COMENTARIOS') || String(h).toUpperCase().includes('PREVIOS') || String(h).toUpperCase().includes('OBSERVACIONES')" class="text-start">
                                    <input v-model="row[h]" class="excel-input" spellcheck="false" style="text-align:left;">
                                </div>
                                <div v-else class="px-1" style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-align:left;" :title="row[h]">{{ row[h] }}</div>
                            </td>
                            <td class="text-center" style="background:#f8f9fa"><button class="btn btn-link btn-sm p-0 text-primary" @click="savePPCV3Row(row)"><i class="fas fa-save"></i></button></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div v-if="currentView === 'PPC_DINAMICO'" class="h-100 dynamic-tracker" style="padding:20px !important;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center"><h4 class="fw-bold m-0 me-3" style="color:#2c3e50"><i class="fas fa-layer-group me-2" style="color:#e83e8c"></i>Tracker</h4><div v-if="currentPpcProject" class="badge bg-white text-dark border p-2 d-flex align-items-center shadow-sm"><i class="fas fa-folder-open text-primary me-2"></i><span>{{ currentPpcProject.name }}</span><button class="btn btn-sm ms-2 text-danger p-0" @click="currentPpcProject = null" title="Quitar filtro"><i class="fas fa-times"></i></button></div></div><button class="btn btn-outline-secondary btn-sm" @click="goHome">Cerrar</button>
          </div>
          <div class="dynamic-form-card">
             <div class="row g-3">
                 <div class="col-md-6"><label class="dynamic-label">Especialidad (Departamento)</label><select v-model="dynamicPpc.especialidad" class="dynamic-input"><option value="" disabled>Seleccionar...</option><option v-for="(d,k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{d.label}}</option></select></div>
                 <div class="col-md-6"><label class="dynamic-label">Clasificación</label><select v-model="dynamicPpc.clasificacion" class="dynamic-input"><option value="A">A</option><option value="AA">AA</option><option value="AAA">AAA</option></select></div>
                 <div class="col-12"><label class="dynamic-label">Responsable</label><div class="dynamic-input" style="min-height:38px; display:flex; flex-wrap:wrap; gap:5px; align-items:center;" @click="$refs.chipDyn.focus()"><span v-for="(u,i) in selectedResponsables" :key="i" class="user-chip">{{u}} <i class="fas fa-times ms-2 text-secondary" style="cursor:pointer" @click.stop="selectedResponsables.splice(i,1)"></i></span><input ref="chipDyn" v-model="staffSearch" style="background:transparent; border:none; color:#333; outline:none; min-width:60px;" placeholder="+"></div><ul class="list-group position-absolute shadow" style="z-index:100; max-height:150px; overflow:auto; width:300px; margin-top:5px;" v-if="staffSearch"><li v-for="p in filteredDirectory" :key="p.name" class="list-group-item list-group-item-action small py-1" style="cursor:pointer;" @click="addResponsable(p.name)">{{p.name}}</li></ul></div>
                 <div class="col-12"><label class="dynamic-label">Descripción</label><textarea v-model="dynamicPpc.concepto" class="dynamic-input" rows="3"></textarea></div>
                 <div class="col-md-6"><label class="dynamic-label">Riesgos</label><div><span v-for="r in ['BAJO','MEDIO','ALTO','CATASTROFICO']" :key="r" class="chip-option" :class="{selected: dynamicPpc.riesgos === r}" @click="dynamicPpc.riesgos = r">{{r}}</span></div></div>
                 <div class="col-md-6"><label class="dynamic-label">Prioridad</label><div><span v-for="p in ['BAJA','MEDIA','URGENTE']" :key="p" class="chip-option" :class="{selected: dynamicPpc.prioridad === p}" @click="dynamicPpc.prioridad = p">{{p}}</span></div></div>
                 <div class="col-md-3"><label class="dynamic-label">Fecha Fin</label><input type="date" v-model="dynamicPpc.fechaFin" class="dynamic-input"></div>
                 <div class="col-md-3"><label class="dynamic-label">Archivos</label><button class="btn btn-outline-primary w-100 btn-sm" @click="openFileDialog" style="border-style:dashed; height:36px;"><i class="fas" :class="uploadSuccess ? 'fa-check text-success' : 'fa-cloud-upload-alt'"></i> {{ uploadSuccess ? 'Listo' : 'SUBIR' }}</button><input type="file" ref="fileInput" class="file-input-hidden" @change="handleFileSelect"></div>
                 <div class="col-md-6"><label class="dynamic-label">Comentarios</label><input v-model="dynamicPpc.comentarios" class="dynamic-input"></div>
             </div>
             <div class="mt-4 text-end"><button class="btn btn-lg fw-bold px-5 text-white" style="background:#e83e8c; border:none;" @click="saveDynamicPPC" :disabled="isSubmitting"><i class="fas fa-save me-2"></i> GUARDAR</button></div>
          </div>
        </div>

        <div v-if="currentView === 'PPC_FORM'" class="h-100 d-flex flex-column" style="background:white; padding:20px;">
           <div class="d-flex justify-content-between align-items-center mb-3">
               <div class="d-flex align-items-center"><h5 class="m-0 text-primary me-3"><i class="fas fa-th me-2"></i>PPC Maestro</h5><div v-if="currentPpcProject" class="badge bg-light text-dark border p-2 d-flex align-items-center animate__animated animate__fadeIn"><i class="fas fa-folder-open text-warning me-2"></i><span>{{ currentPpcProject.name }}</span><span class="ms-2 badge" :class="currentPpcProject.type === 'INTERNO' ? 'bg-secondary' : (currentPpcProject.type === 'PREOPERATIVO' ? 'bg-warning text-dark' : 'bg-primary')">{{ currentPpcProject.type }}</span><button class="btn btn-sm ms-2 text-danger p-0" @click="currentPpcProject = null" title="Quitar filtro"><i class="fas fa-times"></i></button></div></div>
               <div><button class="btn btn-success fw-bold btn-sm me-2 shadow-sm" @click="openPpcProjectSelector"><i class="fas fa-plus-circle me-1"></i> PPC NUEVO</button><button class="btn btn-light border btn-sm" @click="goHome">Cerrar</button></div>
           </div>
           <div class="d-flex mb-3 align-items-end justify-content-center position-relative" style="min-height: 90px;">
               <div class="excel-container" style="height: auto; max-height: none; overflow: visible; flex:none; width: fit-content; z-index: 1; border:none; box-shadow:none; background: transparent;">
                   <table class="table-excel mini-table" style="background: white; border: 1px solid #999;"><thead><tr><th style="width:100px">ESPECIALIDAD</th><th style="width:40px">ACT</th><th style="width:40px">CUMP</th><th style="width:45px">PROM</th><th style="width:40px">ANT</th></tr></thead><tbody><tr v-for="stat in deptStats" :key="stat.key" :class="{'total-row': stat.key === 'TOTAL'}"><td style="font-weight:bold; text-align: left;">{{ stat.label }}</td><td class="text-center">{{ stat.actual }}</td><td class="text-center text-success fw-bold">{{ stat.cumplidas }}</td><td class="text-center">{{ stat.promedio }}</td><td class="text-center text-muted">{{ stat.anterior }}</td></tr></tbody></table>
               </div>
           </div>
           <div class="excel-container flex-fill mb-3">
               <table class="table-excel">
                   <thead><tr><th class="row-num">#</th><th style="width:100px">Depto</th><th style="min-width:400px">Descripción Actividad</th><th style="width:150px">Responsable</th><th style="width:80px">Fecha</th><th style="width:40px">Reloj</th><th style="width:50px">Cumpl.</th><th style="width:40px">Clip</th><th style="min-width:150px">Comentarios</th><th style="min-width:150px">Previos</th><th style="width:50px"></th></tr></thead>
                   <tbody>
                       <tr class="input-row"><td class="row-num">></td><td><select v-model="ppcData.especialidad" class="excel-input" style="background:#f0fdf4"><option value="" disabled>Sel...</option><option v-for="(d,k) in (config.allDepartments || config.departments)" :key="k" :value="k">{{d.label}}</option></select></td><td><input v-model="ppcData.concepto" class="excel-input" placeholder="Descripción..." style="background:#f0fdf4"></td><td style="background:#f0fdf4; position:relative;"><div class="chip-container" @click="$refs.chipIn.focus()"><span v-for="(u,i) in selectedResponsables" :key="i" class="user-chip">{{u}}<i class="fas fa-times ms-1 text-danger" style="cursor:pointer" @click.stop="selectedResponsables.splice(i,1)"></i></span><input ref="chipIn" v-model="staffSearch" style="border:none;outline:none;min-width:40px;font-size:12px;background:transparent;" placeholder="+"></div><ul class="list-group position-absolute w-100 shadow" style="z-index:100;max-height:150px;overflow:auto;top:100%;left:0" v-if="staffSearch"><li v-for="p in filteredDirectory" :key="p.name" class="list-group-item list-group-item-action small py-1" @click="addResponsable(p.name)">{{p.name}}</li></ul></td><td class="text-center small text-muted">HOY</td><td><input v-model="ppcData.horas" class="excel-input" style="background:#f0fdf4; text-align:center;"></td><td><select v-model="ppcData.cumplimiento" class="excel-input" style="background:#f0fdf4"><option value="NO">NO</option><option value="SI">SI</option></select></td><td class="text-center" style="background:#f0fdf4"><button class="btn-attach" :class="{'has-file': uploadSuccess}" @click="openFileDialog"><i class="fas" :class="uploadSuccess ? 'fa-check' : 'fa-paperclip'"></i></button><input type="file" ref="fileInput" class="file-input-hidden" @change="handleFileSelect"></td><td><input v-model="ppcData.comentarios" class="excel-input" placeholder="..." style="background:#f0fdf4"></td><td><input v-model="ppcData.comentariosPrevios" class="excel-input" placeholder="..." style="background:#f0fdf4"></td><td class="text-center"><button class="btn btn-primary btn-sm py-0" @click="promptExtraData" title="Más Detalles">+</button></td></tr>
                       <tr v-for="(item, idx) in activityQueue" :key="idx"><td class="row-num">{{ idx + 1 }}</td><td><input :value="item.especialidad" readonly class="excel-input"></td><td><input :value="item.concepto" readonly class="excel-input"></td><td><div style="padding:0 8px; overflow:hidden; white-space:nowrap; font-size:12px">{{ item.responsable }}</div></td><td class="text-center small">{{ item.fechaAlta ? formatDisplayDate(item.fechaAlta) : new Date().toLocaleDateString() }}</td><td><input :value="item.horas" readonly class="excel-input" style="text-align:center;"></td><td><input :value="item.cumplimiento" readonly class="excel-input"></td><td class="text-center"><i class="fas fa-file-pdf text-danger" v-if="item.archivoUrl"></i></td><td><input :value="item.comentarios" readonly class="excel-input"></td><td><input :value="item.comentariosPrevios" readonly class="excel-input"></td><td class="text-center"><i class="fas fa-trash text-danger" style="cursor:pointer" @click="activityQueue.splice(idx,1); syncQueueToBackend();"></i></td></tr>
                   </tbody>
               </table>
           </div>
           <div class="d-flex justify-content-end mb-4 gap-2"><button class="btn btn-danger fw-bold" @click="clearQueue" :disabled="isSubmitting || !activityQueue.length">DEPURAR</button><button class="btn btn-success fw-bold" @click="submitBatch" :disabled="isSubmitting || !activityQueue.length">{{ isSubmitting ? 'Procesando...' : 'GUARDAR TODO' }}</button></div>
        </div>
      </div>
      <div v-if="['IFRAME', 'MODULE_TABS'].includes(currentView)" class="iframe-container"><div class="iframe-toolbar"><span class="fw-bold">{{ iframeTitle }}</span><button class="btn btn-sm btn-danger" @click="closeIframe">Cerrar</button></div><iframe :src="currentIframeUrl"></iframe></div>
    </main>
  </div>

  <input type="file" ref="cellFileInput" class="file-input-hidden" @change="handleCellFile">

  <div v-if="showExtraModal" class="custom-modal-overlay">
      <div class="custom-modal">
          <div class="custom-modal-header"><span>Detalles</span><button type="button" class="btn-close" @click="showExtraModal = false"></button></div>
          <div class="custom-modal-body">
              <div class="mb-2"><label class="small fw-bold mb-1">Clasificación:</label><div><span v-for="opt in ['A','AA','AAA']" :key="opt" class="chip-select" :class="{active: extraData.clasificacion === opt}" @click="extraData.clasificacion = opt">{{ opt }}</span></div></div>
              <div class="mb-2"><label class="small fw-bold mb-1">Prioridades:</label><div><span v-for="opt in priorityOpts" :key="opt" class="chip-select" :class="{active: extraData.prioridades === opt}" @click="extraData.prioridades = opt">{{ opt }}</span></div></div>
              <div class="mb-2"><label class="small fw-bold mb-1">Riesgos:</label><div><span v-for="opt in riskOpts" :key="opt" class="chip-select" :class="{active: extraData.riesgos === opt}" @click="extraData.riesgos = opt">{{ opt }}</span></div></div>
              <div class="mb-2"><label class="small fw-bold">Restricciones:</label><input v-model="extraData.restricciones" class="form-control form-control-sm"></div>
              <div class="mb-2"><label class="small fw-bold">Fecha Respuesta:</label><input type="date" v-model="extraData.fechaRespuesta" class="form-control form-control-sm"></div>
          </div>
          <div class="custom-modal-footer"><button class="btn btn-primary btn-sm w-100" @click="confirmAddToQueue">Agregar</button></div>
      </div>
  </div>

  <div v-if="showPpcSelectorModal" class="custom-modal-overlay">
      <div class="custom-modal" style="width: 500px;">
          <div class="custom-modal-header">
              <span>Gestión de PPC</span>
              <button type="button" class="btn-close" @click="showPpcSelectorModal = false"></button>
          </div>
          <div class="custom-modal-body">
              <ul class="nav nav-tabs mb-3">
                  <li class="nav-item"><a class="nav-link" :class="{active: ppcMode === 'SELECT'}" href="#" @click.prevent="ppcMode = 'SELECT'">Seleccionar Existente</a></li>
                  <li class="nav-item"><a class="nav-link" :class="{active: ppcMode === 'CREATE'}" href="#" @click.prevent="ppcMode = 'CREATE'">Crear Nuevo</a></li>
              </ul>
              <div v-if="ppcMode === 'SELECT'">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                      <p class="small text-muted m-0">Selecciona un proyecto para cargar tareas:</p>
                      <button class="btn btn-outline-primary btn-sm py-0" style="font-size: 0.7rem;" @click="loadCascadeTree" title="Actualizar Lista"><i class="fas fa-sync-alt"></i></button>
                  </div>
                  <div class="list-group" style="max-height: 250px; overflow-y: auto;">
                      <template v-for="site in activeProjectsList" :key="site.id">
                          <div class="list-group-item list-group-item-light fw-bold small text-uppercase bg-light text-muted"><i class="fas fa-building me-1"></i> {{ site.name }}</div>
                          <a href="#" v-for="sub in (site.subProjects || [])" :key="sub.name" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center ps-4" @click.prevent="selectPpcProject(sub)"><div><i class="fas fa-angle-right me-2 text-primary"></i><strong>{{ sub.name }}</strong></div><span class="badge bg-secondary" style="font-size: 0.65rem">{{ sub.type }}</span></a>
                          <div v-if="!site.subProjects || site.subProjects.length === 0" class="ps-4 py-2 small text-muted fst-italic">Sin subproyectos.</div>
                      </template>
                  </div>
              </div>
              <div v-if="ppcMode === 'CREATE'">
                  <div class="d-flex justify-content-center mb-3 bg-light p-2 rounded">
                      <div class="form-check form-check-inline m-0 me-3"><input class="form-check-input" type="radio" id="radioSite" value="SITE" v-model="newProject.creationMode"><label class="form-check-label small fw-bold" for="radioSite">Nuevo Sitio (Padre)</label></div>
                      <div class="form-check form-check-inline m-0"><input class="form-check-input" type="radio" id="radioSub" value="SUB" v-model="newProject.creationMode"><label class="form-check-label small fw-bold" for="radioSub">Nuevo Subproyecto</label></div>
                  </div>
                  <div class="mb-3"><label class="form-label small fw-bold text-danger">Creado por (Obligatorio)</label><input v-model="newProject.createdBy" class="form-control" placeholder="Tu nombre..."></div>
                  <div v-if="newProject.creationMode === 'SITE'" class="animate__animated animate__fadeIn">
                      <div class="mb-3"><label class="form-label small fw-bold">Nombre del Sitio</label><input v-model="newProject.name" class="form-control" placeholder="Ej: NAVE INDUSTRIAL 4"></div>
                      <div class="mb-3"><label class="form-label small fw-bold">Cliente</label><input v-model="newProject.client" class="form-control" placeholder="Ej: NIDEC"></div>
                      <div class="mb-3"><label class="form-label small fw-bold text-danger">Tipo de PPC *</label><div class="d-flex gap-2"><div class="project-type-option" :class="{selected: newProject.type === 'INTERNO'}" @click="newProject.type = 'INTERNO'">INTERNO</div><div class="project-type-option" :class="{selected: newProject.type === 'CLIENTE'}" @click="newProject.type = 'CLIENTE'">CLIENTE</div><div class="project-type-option" :class="{selected: newProject.type === 'PREOPERATIVO'}" @click="newProject.type = 'PREOPERATIVO'">PREOPERATIVO</div></div></div>
                  </div>
                  <div v-else class="animate__animated animate__fadeIn">
                      <div class="mb-3"><label class="form-label small fw-bold text-primary">Selecciona el Sitio Padre:</label><select v-model="newProject.parentId" class="form-select border-primary"><option value="" disabled>-- Elige un Sitio --</option><option v-for="site in activeProjectsList" :key="site.id" :value="site.id">{{ site.name }} ({{site.client}})</option></select></div>
                      <div class="mb-3"><label class="form-label small fw-bold">Nombre del Subproyecto</label><input v-model="newProject.name" class="form-control" placeholder="Ej: TERRACERIAS FASE 1"></div>
                      <div class="mb-3"><label class="form-label small fw-bold">Especialidad</label><div class="d-flex gap-1 overflow-auto pb-1"><span v-for="t in ['OBRA CIVIL','HVAC','ELECTRICO','ESTRUCTURA','ACABADOS']" :key="t" class="badge border text-dark p-2" :class="newProject.type === t ? 'bg-primary text-white' : 'bg-light'" style="cursor:pointer" @click="newProject.type = t">{{t}}</span></div></div>
                  </div>
                  <button class="btn btn-success w-100 fw-bold" @click="createNewProject" :disabled="isSubmitting || !newProject.name || !newProject.createdBy || (newProject.creationMode === 'SUB' && !newProject.parentId)"><span v-if="isSubmitting"><i class="fas fa-spinner fa-spin"></i> Procesando...</span><span v-else>CREAR Y SELECCIONAR</span></button>
              </div>
          </div>
      </div>
  </div>

  <div v-if="showSubProjectModal" class="custom-modal-overlay">
    <div class="custom-modal" style="width: 400px;">
        <div class="custom-modal-header"><span>Nuevo Subproyecto</span><button type="button" class="btn-close" @click="showSubProjectModal = false"></button></div>
        <div class="custom-modal-body">
            <p class="small text-muted mb-3">Agregando a: <strong>{{ currentTargetSite.name }}</strong></p>
            <div class="mb-3"><label class="form-label small fw-bold text-danger">Creado por (Obligatorio)</label><input v-model="newSubProject.createdBy" class="form-control" placeholder="Tu nombre..."></div>
            <div class="mb-3"><label class="form-label small fw-bold">Nombre Subproyecto</label><input v-model="newSubProject.name" class="form-control" placeholder="Ej: TERRACERIAS FASE 1"></div>
            <div class="mb-3"><label class="form-label small fw-bold">Especialidad / Tipo</label><select v-model="newSubProject.type" class="form-select"><option value="OBRA CIVIL">OBRA CIVIL</option><option value="ESTRUCTURA">ESTRUCTURA</option><option value="INSTALACIONES">INSTALACIONES</option><option value="ACABADOS">ACABADOS</option><option value="HVAC">HVAC</option></select></div>
            <button class="btn btn-success w-100 fw-bold" @click="createSubProject" :disabled="isSubmitting || !newSubProject.name || !newSubProject.createdBy"><span v-if="isSubmitting"><i class="fas fa-spinner fa-spin"></i> Guardando...</span><span v-else>CREAR SUBPROYECTO</span></button>
        </div>
    </div>
  </div>

</div>

<script>
  window.onerror = function(msg, url, line) { if(String(msg).toLowerCase().includes("script error")) return; Swal.fire({ icon: 'error', title: 'Error de Renderizado', text: 'Ocurrió un error visual: ' + err.message }); };

  const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;
  const app = createApp({
    setup() {
      // ESTADO GLOBAL
      const isLoggedIn = ref(false); const loginPass = ref(''); const loginUser = ref(''); const loggingIn = ref(false); const currentUser = ref(''); const currentUsername = ref(''); const currentRole = ref('');
      const currentView = ref('DASHBOARD'); const currentDept = ref('');
      const config = ref({ departments: {}, staff: [], directory: [], specialModules: [] });
      const staffTracker = ref({ name: '', data: [], history: [], headers: [], isLoading: false, previousView: 'DEPT' });
      const weeklyPlanData = ref({ headers: [], data: [], isLoading: false }); 
      const searchQuery = ref(''); const isCompact = ref(false); 
      const showPassword = ref(false); // NUEVA VARIABLE PARA TOGGLE PASSWORD
      
      const ppcData = ref({ cumplimiento: 'NO', cliente: '', comentarios:'', comentariosPrevios:'' }); 
      const isSubmitting = ref(false);
      const selectedResponsables = ref([]); const staffSearch = ref(''); const activityQueue = ref([]); 
      const ppcExistingData = ref([]); 
      
      const isUploadingFile = ref(false); const uploadSuccess = ref(false); const fileInput = ref(null);
      const currentIframeUrl = ref(''); const iframeTitle = ref(''); 
      const showExtraModal = ref(false);
      const extraData = ref({ restricciones: '', prioridades: '', riesgos: '', fechaRespuesta: '', clasificacion: '' });
      const priorityOpts = ['URGENTE', 'MEDIA', 'BAJA']; const riskOpts = ['ALTO', 'BAJO', 'CATASTROFICO'];
      const cellFileInput = ref(null); const uploadingCell = ref({row:null, col:null});
      const dynamicPpc = ref({ especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' });

      const selectedWeek = ref(''); 
      const currentModuleId = ref('');
      
      // NUEVOS FILTROS PPC SEMANAL
      const filterSpecialty = ref('');
      const filterCompliance = ref('');

      // ECG (Electrocardiograma) STATE
      const ecgData = ref({});
      const ecgChartInstances = {};

      // KPI STATE
      const kpiData = ref({ ventas: [], tracker: [], antonia: null, isLoading: false });
      const kpiChartInstances = { ventas: null, tracker: null, antonia: null };

      // --- GESTIÓN DE PROYECTOS (V138 - CASCADA) ---
      const showPpcSelectorModal = ref(false);
      const ppcMode = ref('SELECT');
      const currentPpcProject = ref(null);
      const newProject = ref({ name: '', client: '', type: 'OBRA CIVIL', creationMode: 'SUB', parentId: '', createdBy: '' });
      watch(() => newProject.value.creationMode, (newVal) => {
          if (newVal === 'SITE') { newProject.value.type = 'CLIENTE'; } else { newProject.value.type = 'OBRA CIVIL'; }
      });
      const activeProjectsList = ref([]);
      const showSubProjectModal = ref(false);
      const currentTargetSite = ref({});
      const newSubProject = ref({ name: '', type: 'OBRA CIVIL', createdBy: '' });
      
      // *** MODIFICADO: ESTRUCTURA DE CARPETAS CON NUEVOS PPCs ***
      const projectSubFolders = ref([
          { name: "PPC INTERNO", icon: "fa-tasks", color: "#fd7e14", bg: "#fff4de" }, 
          { name: "PPC PREOPERATIVO", icon: "fa-tasks", color: "#fd7e14", bg: "#fff4de" },
          { name: "PPC CLIENTE", icon: "fa-tasks", color: "#fd7e14", bg: "#fff4de" },
          { name: "DOCUMENTOS", icon: "fa-file-alt", color: "#3699ff", bg: "#e1f0ff" },
          { name: "PLANOS Y DISEÑOS", icon: "fa-drafting-compass", color: "#6610f2", bg: "#eee5ff" },
          { name: "FOTOGRAFIAS", icon: "fa-images", color: "#e83e8c", bg: "#ffe2e5" },
          { name: "CORRESPONDENCIA", icon: "fa-envelope-open-text", color: "#ffc107", bg: "#fff4de" },
          { name: "REPORTES", icon: "fa-chart-pie", color: "#198754", bg: "#c9f7f5" }
      ]);
      const projectCards = ref([]);
      const projectTasks = ref({ data: [], headers: [], isLoading: false });

      const toggleExpand = (item) => { item.expanded = !item.expanded; };
      
      // *** MODIFICADO: ABRIR CONTENIDO CON ETIQUETADO DINÁMICO ***
      const openFolderContent = (folder, projectName) => {
          if (folder.name.includes("PPC")) {
             // ETIQUETA DINÁMICA: "NAVE PPC INTERNO", "AMPLIACION PPC CLIENTE", etc.
             const compoundName = `${projectName} ${folder.name}`;
             currentPpcProject.value = { name: compoundName }; 
             currentView.value = 'PROJECT_TASKS_VIEW';
             loadProjectTasks(compoundName);
          } else {
             Swal.fire({ title: `${folder.name} (${projectName})`, text: 'Carpeta vacía por el momento.', icon: 'info', iconColor: folder.color, confirmButtonColor: folder.color });
          }
      };
      
      const loadProjectTasks = (projectName) => {
          projectTasks.value.isLoading = true;
          google.script.run.withSuccessHandler(res => {
              projectTasks.value.isLoading = false;
              if (res.success) { projectTasks.value.data = res.data; projectTasks.value.headers = res.headers; } 
              else { Swal.fire('Error', res.message, 'error'); }
          }).apiFetchProjectTasks(projectName);
      };

      const refreshProjectTasks = () => { if(currentPpcProject.value) loadProjectTasks(currentPpcProject.value.name); };
      const addNewProjectTask = () => { if (!projectTasks.value.headers.length) return; const row = { _isNew: true }; projectTasks.value.headers.forEach(h => row[h] = ""); row['ESTATUS'] = 'PENDIENTE'; projectTasks.value.data.unshift(row); };
      const saveProjectRow = (row) => {
          if(!currentPpcProject.value) return;
          Swal.showLoading();
          google.script.run.withSuccessHandler(res => {
              Swal.close();
              if (res.success) { row._isNew = false; if(res.moved) { refreshProjectTasks(); Swal.fire({ icon: 'success', title: 'Archivado', timer: 1000, showConfirmButton: false }); } else { Swal.fire({ icon: 'success', title: 'Guardado', timer: 1000, showConfirmButton: false }); refreshProjectTasks(); } } 
              else { Swal.fire('Error', res.message, 'error'); }
          }).apiSaveProjectTask(JSON.parse(JSON.stringify(row)), currentPpcProject.value.name);
      };

      const loadCascadeTree = () => {
          google.script.run.withSuccessHandler(res => {
              if (res.success && res.data.length > 0) {
                  const oldState = {}; activeProjectsList.value.forEach(p => oldState[p.id] = p.expanded);
                  activeProjectsList.value = res.data.map(site => ({ ...site, expanded: oldState[site.id] || false }));
              }
          }).apiFetchCascadeTree();
      };

      const openPpcProjectSelector = () => { showPpcSelectorModal.value = true; ppcMode.value = 'SELECT'; newProject.value = { name: '', client: '', type: 'OBRA CIVIL', creationMode: 'SUB', parentId: '', createdBy: '' }; };
      const selectPpcProject = (proj) => { currentPpcProject.value = proj; showPpcSelectorModal.value = false; if (currentView.value === 'PROJECTS') { openModule({ id: 'PPC_MASTER', type: 'ppc_native' }); } };
      const createNewProject = () => {
          if (!newProject.value.name || !newProject.value.createdBy) return;
          isSubmitting.value = true;
          if (newProject.value.creationMode === 'SUB') {
              google.script.run.withSuccessHandler(res => {
                  if (res.success) {
                      Swal.fire({ icon: 'success', title: '¡Creado!', text: 'Se ha guardado en la base de datos.', timer: 1500, showConfirmButton: false });
                      google.script.run.withSuccessHandler(treeRes => { isSubmitting.value = false; if (treeRes.success) { activeProjectsList.value = treeRes.data; const parent = activeProjectsList.value.find(p => String(p.id) === String(newProject.value.parentId)); if (parent) { const createdSub = parent.subProjects.find(s => s.name === newProject.value.name.toUpperCase().trim()); if (createdSub) selectPpcProject(createdSub); } newProject.value = { name: '', client: '', type: 'OBRA CIVIL', creationMode: 'SUB', parentId: '', createdBy: '' }; } }).apiFetchCascadeTree();
                  } else { isSubmitting.value = false; Swal.fire('Error', res.message, 'error'); }
              }).apiSaveSubProject({ parentId: newProject.value.parentId, name: newProject.value.name, type: newProject.value.type, createdBy: newProject.value.createdBy });
          } else {
              google.script.run.withSuccessHandler(res => {
                  if (res.success) {
                      Swal.fire({ icon: 'success', title: 'Sitio Creado', text: 'Ahora agrega subproyectos.', timer: 2000, showConfirmButton: false });
                      google.script.run.withSuccessHandler(treeRes => { isSubmitting.value = false; if(treeRes.success) { activeProjectsList.value = treeRes.data; newProject.value.creationMode = 'SUB'; newProject.value.parentId = res.id; newProject.value.name = ''; } }).apiFetchCascadeTree();
                  } else { isSubmitting.value = false; Swal.fire('Error', res.message, 'error'); }
              }).apiSaveSite({ name: newProject.value.name, client: newProject.value.client, type: newProject.value.type, createdBy: newProject.value.createdBy });
          }
      };

      const openAddSubProject = (site) => { currentTargetSite.value = site; newSubProject.value = { name: '', type: 'OBRA CIVIL', createdBy: '' }; showSubProjectModal.value = true; };
      const createSubProject = () => {
          if (!newSubProject.value.name || !newSubProject.value.createdBy) return;
          isSubmitting.value = true;
          google.script.run.withSuccessHandler(res => {
              if (res.success) {
                  Swal.fire({ icon: 'success', title: 'Subproyecto Agregado', timer: 1500, showConfirmButton: false });
                  showSubProjectModal.value = false; 
                  google.script.run.withSuccessHandler(treeRes => { isSubmitting.value = false; if(treeRes.success) { activeProjectsList.value = treeRes.data; const updatedSite = activeProjectsList.value.find(s => s.id === currentTargetSite.value.id); if(updatedSite) updatedSite.expanded = true; } }).apiFetchCascadeTree();
              } else { isSubmitting.value = false; Swal.fire('Error', res.message, 'error'); }
          }).apiSaveSubProject({ parentId: currentTargetSite.value.id, name: newSubProject.value.name, type: newSubProject.value.type, createdBy: newSubProject.value.createdBy });
      };
      const openProjectTask = (sub) => { currentPpcProject.value = sub; openModule({ id: "PPC_DINAMICO", type: "ppc_dynamic_view" }); };

      // --- LOGICA GENERAL Y COMPUTED ---
      const salesStaff = computed(() => (config.value.directory || []).filter(p => p.dept === 'VENTAS' && p.name !== 'ANTONIA_VENTAS').map(p => p.name));
      const filteredStaff = computed(() => config.value.staff.filter(p => p.dept === currentDept.value && p.name.toLowerCase().includes(searchQuery.value.toLowerCase())));
      const filteredDirectory = computed(() => (config.value.directory || config.value.staff).filter(p => p.name.toLowerCase().includes(staffSearch.value.toLowerCase()) && !selectedResponsables.value.includes(p.name)).slice(0,5));
      const pageTitle = computed(() => currentView.value);
      const currentDeptData = computed(() => config.value.departments[currentDept.value] || {});

      const deptStats = computed(() => {
          const stats = []; let totalActual=0; let totalCumplidas=0; let totalGlobalDB=0;
          const deptsToIterate = config.value.allDepartments || config.value.departments;
          for (const key in deptsToIterate) {
              const deptLabel = deptsToIterate[key].label;
              const actual = activityQueue.value.filter(i => i.especialidad === key).length;
              const totalDB = ppcExistingData.value.filter(i => i.especialidad === key || i.especialidad === deptLabel);
              const cumplidas = totalDB.filter(i => String(i.cumplimiento).toUpperCase() === 'SI').length;
              let prom = 0; if (totalDB.length > 0) prom = Math.round((cumplidas / totalDB.length) * 100);
              totalActual += actual; totalCumplidas += cumplidas; totalGlobalDB += totalDB.length;
              stats.push({ key: key, label: deptLabel.toUpperCase(), actual: actual, cumplidas: cumplidas, promedio: prom + '%', anterior: '0%' });
          }
          let totalProm = 0; if (totalGlobalDB > 0) totalProm = Math.round((totalCumplidas / totalGlobalDB) * 100);
          stats.push({ key: 'TOTAL', label: 'TOTAL', actual: totalActual, cumplidas: totalCumplidas, promedio: totalProm + '%', anterior: '0%' });
          return stats;
      });

      const availableWeeks = computed(() => { const allWeeks = weeklyPlanData.value.data.map(i => i.SEMANA).filter(w => w && w !== '-'); return [...new Set(allWeeks)].sort((a,b) => b - a); });
      const availableSpecialties = computed(() => [...new Set(weeklyPlanData.value.data.map(r => r.ESPECIALIDAD).filter(x => x))].sort());

      const filteredWeeklyData = computed(() => { 
          let data = weeklyPlanData.value.data;
          if (selectedWeek.value) { data = data.filter(r => String(r.SEMANA) == String(selectedWeek.value)); }
          if (filterSpecialty.value) { data = data.filter(r => String(r.ESPECIALIDAD).trim() === String(filterSpecialty.value).trim()); }
          if (filterCompliance.value) { data = data.filter(r => String(r.CUMPLIMIENTO).toUpperCase().trim() === String(filterCompliance.value).toUpperCase().trim()); }
          return data; 
      });

      const weeklyStats = computed(() => {
           const data = filteredWeeklyData.value || []; const stats = []; let grandTotal = 0; let grandSi = 0;
           const depts = config.value.allDepartments || config.value.departments || {}; const norm = s => String(s||'').toUpperCase().trim();
           for (const key in depts) {
               const label = depts[key].label.toUpperCase();
               const items = data.filter(r => { const s = norm(r['ESPECIALIDAD'] || r['AREA']); return s === key || s === norm(depts[key].label); });
               const t = items.length; const s = items.filter(r => norm(r['CUMPLIMIENTO']) === 'SI').length; const n = t - s; const p = t > 0 ? Math.round((s/t)*100) : 0;
               stats.push({ label: label, total: t, si: s, no: n, avg: p + '%' }); grandTotal += t; grandSi += s;
           }
           const grandNo = grandTotal - grandSi; const grandAvg = grandTotal > 0 ? Math.round((grandSi/grandTotal)*100) : 0;
           stats.push({ label: 'TOTAL GLOBAL', total: grandTotal, si: grandSi, no: grandNo, avg: grandAvg + '%', isTotal: true }); return stats;
      });

      const isCol = (h, list) => list.includes(String(h).toUpperCase().trim());
      const getColumnStyle = (h) => {
          const up = String(h).toUpperCase().trim(); let w = '120px'; let fs = '12px'; let pad = '8px 4px'; let align = 'left';
          if (up === 'CONCEPTO' || up.includes('DESCRIP')) { w = (staffTracker.value.name === 'ANTONIA_VENTAS') ? '600px' : '380px'; }
          else if (isCol(h, ['ESPECIALIDAD', 'AREA', 'DEPTO'])) { w = '50px'; fs = '11px'; } 
          else if (isCol(h, ['ID', 'FOLIO'])) { w = '40px'; fs = '10px'; align = 'center'; } 
          else if (up.includes('CUMPLIMIENTO')) { w = '50px'; align = 'center'; fs = '11px'; }
          else if (up.includes('ARCHIVO') || up.includes('CLIP')) { w = '40px'; align = 'center'; }
          else if (up === 'SEMANA') { w = '50px'; align = 'center'; }
          else if (up === 'HORA') { w = '50px'; fs = '10px'; }
          else if (up === 'FECHA ESTIMADA DE FIN' || up === 'FECHA DE ENTREGA') { w = '75px'; fs = '10px'; }
          else if (up === 'HORA ESTIMADA DE FIN') { w = '60px'; fs = '10px'; }
          else if (up.includes('PRIORIDAD')) { w = '70px'; fs = '10px'; } 
          else if (up.includes('RIESGO')) { w = '70px'; fs = '10px'; }
          else if (up === 'REQUISITOR') { w = '90px'; fs = '11px'; } 
          else if (up === 'INFO CLIENTE') { w = '70px'; fs = '10px'; align='center'; } 
          else if (isCol(h, ['DIAS','RELOJ','CLASIFICACION'])) { w = '40px'; fs = '10px'; pad = '8px 1px'; }
          else if (up.includes('AVANCE')) { w = '40px'; fs = '10px'; pad = '8px 1px'; }
          else if (isCol(h, ['ESTATUS','STATUS'])) { w = '65px'; fs = '10px'; pad = '8px 1px'; }
          else if (up.includes('FECHA') || up.includes('RESPUESTA')) { w = '65px'; fs = '10px'; } 
          else if (up === 'F2') { w = '35px'; fs = '10px'; align='center'; } 
          else if (up.includes('COTIZACION') || up.includes('COT')) { w = '70px'; fs = '10px'; align='center'; } 
          else if (up.includes('TIMEOUT') || up.includes('TIME OUT')) { w = '70px'; fs = '10px'; align='center'; } 
          else if (up.includes('LAYOUT') || up.includes('TIMELINE')) { w = '70px'; fs = '10px'; align='center'; } 
          else if (up.includes('VENDEDOR')) { w = '50px'; fs = '10px'; align='center'; } 
          else if (up === 'CLIENTE') w = '100px';
          return { width: w, fontSize: fs, padding: pad, textAlign: align, overflow: 'hidden', textOverflow: 'ellipsis' };
      };
      
      const getHeaderLabel = (h) => { const up = String(h).toUpperCase().trim(); if (up === 'CLASIFICACION') return 'CLASI'; if (up === 'FECHA ESTIMADA DE FIN') return 'FEC. EST. FIN'; if (up === 'HORA ESTIMADA DE FIN') return 'HR. EST. FIN'; return h; };
      const isMediaColumn = (h) => ['F2','COTIZACION','COT','COTIZACIÓN','TIMEOUT','TIME OUT','LAYOUT','TIMELINE','INFO CLIENTE'].includes(String(h).toUpperCase());
      const getTrafficStyle = (row) => { const t = String(row['CLASIFICACION']||'').trim().toUpperCase(); const d = parseInt(row['DIAS']||row['RELOJ']||0); if (isNaN(d)) return {}; if(t==='A') return d>=3?{backgroundColor:'#e74c3c',color:'white'}:(d===2?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'}); if(t==='AA') return d>=7?{backgroundColor:'#e74c3c',color:'white'}:(d>=4?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'}); if(t==='AAA') return d>=30?{backgroundColor:'#e74c3c',color:'white'}:(d>=11?{backgroundColor:'#f1c40f',color:'black'}:{backgroundColor:'#2ecc71',color:'white'}); return {}; };
      const getFechaRespuestaStyle = (row) => { const startKey = Object.keys(row).find(k => ['FECHA','FECHA INICIO','FECHA DE INICIO'].includes(String(k).toUpperCase().trim())); const startDateVal = startKey ? row[startKey] : null; const style = { backgroundColor: '#ffc107', color: 'black' }; if (!startDateVal) return style; let startDate = null; if (typeof startDateVal === 'string') { const parts = startDateVal.split('/'); if (parts.length === 3) { let y = parts[2].length === 2 ? '20' + parts[2] : parts[2]; startDate = new Date(`${y}-${parts[1]}-${parts[0]}`); } } else if (startDateVal instanceof Date) { startDate = startDateVal; } if (startDate && !isNaN(startDate.getTime())) { const diff = new Date() - startDate; if (Math.floor(diff / (1000 * 60 * 60 * 24)) > 3) { style.backgroundColor = '#dc3545'; style.color = 'white'; } } return style; };

      const toInitials = (name) => {
        if (!name) return '';
        // Convierte "Judith Echavarria" en "JE", o "Maria Del Carmen" en "MC"
        return String(name).trim().split(/\s+/).map(p => p[0]).join('').toUpperCase().substring(0, 3);
      };

      const handleErr = (e) => { loggingIn.value=false; isSubmitting.value=false; Swal.fire('Error',e.message,'error'); };
      const doLogin = () => { if(!loginPass.value || !loginUser.value) return; loggingIn.value=true; google.script.run.withSuccessHandler(res => { loggingIn.value=false; if(res.success){ isLoggedIn.value=true; currentUser.value=res.name; currentUsername.value = res.username; currentRole.value = res.role; loadConfig(res.role); loadCascadeTree(); } else Swal.fire('Error',res.message,'error'); }).withFailureHandler(handleErr).apiLogin(loginUser.value, loginPass.value); };
      const loadConfig = (r) => { google.script.run.withSuccessHandler(d => { config.value=d; if(r === 'PPC_ADMIN' || r === 'ADMIN_CONTROL' || r === 'ADMIN') { google.script.run.withSuccessHandler(res => { if(res.success && res.data.length > 0) { activityQueue.value = res.data; } }).apiFetchDrafts(); } }).getSystemConfig(r); };
      const toggleSidebar = () => { isCompact.value = !isCompact.value; };
      const logout = () => { isLoggedIn.value=false; loginPass.value=''; loginUser.value=''; currentView.value='DASHBOARD'; };
      const goHome = () => { currentView.value='DASHBOARD'; currentDept.value=''; currentModuleId.value=''; };
      const selectDept = (k) => { currentDept.value=k; currentView.value='DEPT'; searchQuery.value=''; currentModuleId.value=''; };
      const goBackToDept = () => currentView.value=staffTracker.value.previousView;
      
      const loadWeeklyPlan = () => { weeklyPlanData.value.isLoading = true; google.script.run.withSuccessHandler(res => { weeklyPlanData.value.isLoading = false; if(res.success){ weeklyPlanData.value.headers = res.headers; weeklyPlanData.value.data = res.data; selectedWeek.value = ''; } else Swal.fire('Error', res.message, 'error'); }).apiFetchWeeklyPlanData(); };
      const savePPCV3Row = (row) => { const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 }); Toast.fire({ icon: 'info', title: 'Guardando...' }); google.script.run.withSuccessHandler(res => { if(res.success) Toast.fire({ icon: 'success', title: 'Actualizado' }); else Swal.fire('Error', res.message, 'error'); }).apiUpdatePPCV3(JSON.parse(JSON.stringify(row))); };

      // ECG LOGIC
      const loadEcgData = () => {
          if(currentView.value !== 'ECG_VIEW') return;
          Swal.showLoading();
          google.script.run.withSuccessHandler(res => {
              Swal.close();
              if (res.success) {
                  ecgData.value = res.data;
                  nextTick(() => { renderEcgCharts(); });
              } else {
                  Swal.fire('Error', res.message, 'error');
              }
          }).apiFetchSalesHistory();
      };

      const renderEcgCharts = () => {
          Object.keys(ecgData.value).forEach(personName => {
              const canvasId = 'chart-' + personName.replace(/\s+/g, '');
              const ctx = document.getElementById(canvasId);
              if (!ctx) return;

              if (ecgChartInstances[personName]) {
                  ecgChartInstances[personName].destroy();
              }

              const dataPoints = ecgData.value[personName];
              const labels = dataPoints.map(d => d.displayDate);
              const values = dataPoints.map(d => d.pulse);
              
              let borderColor = '#00ff00';
              if(personName.includes("SEBASTIAN")) borderColor = '#00ccff';
              if(personName.includes("EDUARDO")) borderColor = '#ff9900';

              ecgChartInstances[personName] = new Chart(ctx, {
                  type: 'line',
                  data: {
                      labels: labels,
                      datasets: [{
                          label: 'Señal de Ventas',
                          data: values,
                          borderColor: borderColor,
                          borderWidth: 2,
                          tension: 0.1, 
                          pointRadius: 3,
                          pointBackgroundColor: '#fff'
                      }]
                  },
                  options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {
                          x: { display: false }, 
                          y: { 
                              display: true, 
                              grid: { color: '#222' },
                              ticks: { color: '#555', callback: (v) => v > 5 ? 'VENDIDA' : (v < 0 ? 'PERDIDA' : '') }
                          }
                      },
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              callbacks: {
                                  label: (ctx) => {
                                      const idx = ctx.dataIndex;
                                      const item = dataPoints[idx];
                                      return `${item.status}: ${item.desc} (${item.client})`;
                                  }
                              }
                          }
                      },
                      animation: { duration: 1500, easing: 'easeOutQuart' }
                  }
              });
          });
      };

      const openModule = (m) => { 
          currentModuleId.value = m.id; currentDept.value = ''; 
          if(m.type==='mirror_staff') { openStaffTracker({name:m.target}); }
          else if(m.type==='ppc_native') { currentView.value='PPC_FORM'; google.script.run.withSuccessHandler(res => { if(res.success) ppcExistingData.value = res.data; }).apiFetchPPCData(); }
          else if(m.type==='ppc_dynamic_view') { currentView.value='PPC_DINAMICO'; dynamicPpc.value = { especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' }; selectedResponsables.value = []; uploadSuccess.value = false; }
          else if(m.type==='weekly_plan_view') { currentView.value='WEEKLY_PLAN'; loadWeeklyPlan(); }
          else if(m.type === 'ecg_dashboard') {
              currentView.value = 'ECG_VIEW';
              loadEcgData();
          }
          else if(m.type === 'kpi_dashboard_view') {
              // Allow TONITA to also see dashboard (mock data)
              if (currentUsername.value !== 'LUIS_CARLOS' && currentRole.value !== 'ADMIN' && currentRole.value !== 'TONITA') {
                  Swal.fire('Acceso Denegado', 'No tienes permisos para ver este módulo.', 'error');
                  return;
              }
              currentView.value = 'KPI_DASHBOARD';
              loadKPIData();
          }
      };

      const loadKPIData = () => {
          kpiData.value.isLoading = true;
          google.script.run.withSuccessHandler(res => {
              kpiData.value.isLoading = false;
              if (res.success) {
                  kpiData.value.ventas = res.ventas;
                  kpiData.value.tracker = res.tracker;
                  kpiData.value.antonia = res.antonia_productivity;
                  nextTick(() => { renderKPICharts(); });
              } else {
                  Swal.fire('Error', res.message || 'No se pudieron cargar los KPIs.', 'error');
              }
          }).apiFetchTeamKPIData(currentUsername.value);
      };

      const renderKPICharts = () => {
          // ANTONIA CHART
          const ctxAntonia = document.getElementById('kpiChartAntonia');
          if (ctxAntonia && kpiData.value.antonia) {
               if (kpiChartInstances.antonia) kpiChartInstances.antonia.destroy();

               kpiChartInstances.antonia = new Chart(ctxAntonia, {
                   type: 'bar',
                   data: {
                       labels: kpiData.value.antonia.labels,
                       datasets: [{
                           label: 'Frecuencia de Ingreso',
                           data: kpiData.value.antonia.values,
                           backgroundColor: '#0dcaf0'
                       }]
                   },
                   options: {
                       responsive: true, maintainAspectRatio: false,
                       scales: {
                           y: { beginAtZero: true, title: { display:true, text: 'Cantidad' }, ticks: { stepSize: 1 } }
                       }
                   }
               });
          }

          // VENTAS CHART
          const ctxVentas = document.getElementById('kpiChartVentas');
          if (ctxVentas && kpiData.value.ventas.length) {
               if (kpiChartInstances.ventas) kpiChartInstances.ventas.destroy();
               const labels = kpiData.value.ventas.map(u => u.name.split(' ')[0]); // First name only
               const dataEff = kpiData.value.ventas.map(u => u.efficiency);
               const dataVol = kpiData.value.ventas.map(u => u.volume);

               kpiChartInstances.ventas = new Chart(ctxVentas, {
                   type: 'bar',
                   data: {
                       labels: labels,
                       datasets: [
                           { label: 'Eficiencia (Días)', data: dataEff, backgroundColor: '#2c3e50', yAxisID: 'y' },
                           { label: 'Volumen', data: dataVol, type: 'line', borderColor: '#e67e22', tension: 0.1, yAxisID: 'y1' }
                       ]
                   },
                   options: {
                       responsive: true, maintainAspectRatio: false,
                       scales: {
                           y: { type: 'linear', display: true, position: 'left', title: { display:true, text: 'Días Promedio' } },
                           y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display:true, text: 'Tareas' } }
                       }
                   }
               });
          }

          // TRACKER CHART
          const ctxTracker = document.getElementById('kpiChartTracker');
          if (ctxTracker && kpiData.value.tracker.length) {
               if (kpiChartInstances.tracker) kpiChartInstances.tracker.destroy();
               const labels = kpiData.value.tracker.map(u => u.name.split(' ')[0]);
               const dataEff = kpiData.value.tracker.map(u => u.efficiency);
               const dataVol = kpiData.value.tracker.map(u => u.volume);

               kpiChartInstances.tracker = new Chart(ctxTracker, {
                   type: 'bar',
                   data: {
                       labels: labels,
                       datasets: [
                           { label: 'Eficiencia (Días)', data: dataEff, backgroundColor: '#e74c3c', yAxisID: 'y' },
                           { label: 'Volumen', data: dataVol, type: 'line', borderColor: '#8e44ad', tension: 0.1, yAxisID: 'y1' }
                       ]
                   },
                   options: {
                       responsive: true, maintainAspectRatio: false,
                       scales: {
                           y: { type: 'linear', display: true, position: 'left', title: { display:true, text: 'Días Promedio' } },
                           y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: { display:true, text: 'Tareas' } }
                       }
                   }
               });
          }
      };
      
      const closeIframe = () => currentView.value='DASHBOARD';
      const openStaffTracker = (p) => { staffTracker.value.name=p.name; staffTracker.value.previousView=currentView.value; currentView.value='STAFF_TRACKER'; staffTracker.value.isLoading=true; google.script.run.withSuccessHandler(res => { staffTracker.value.isLoading=false; if(res.success){ staffTracker.value.data=res.data; staffTracker.value.history=res.history; staffTracker.value.headers=res.headers; } else Swal.fire('Error',res.message,'error'); }).withFailureHandler(handleErr).apiFetchStaffTrackerData(p.name); };
      const reloadStaffTracker = () => openStaffTracker({name:staffTracker.value.name});
      const addNewRow = () => { if(!staffTracker.value.headers.length) return; const row={_isNew:true}; staffTracker.value.headers.forEach(h=>row[h]=""); staffTracker.value.data.unshift(row); };
      const saveRow = (row) => { Swal.showLoading(); google.script.run.withSuccessHandler(res => { Swal.close(); if(res.success){ row._isNew=false; if(res.moved){ reloadStaffTracker(); Swal.fire({icon: 'success', title: 'Archivado', text: 'Tarea movida a Realizadas (100%)', timer: 1500, showConfirmButton: false}); } else { Swal.fire({icon: 'success', title: 'Guardado', timer: 1000, showConfirmButton: false}); } } else { Swal.fire('Error', res.message, 'error'); } }).withFailureHandler(handleErr).apiUpdateTask(staffTracker.value.name, JSON.parse(JSON.stringify(row))); };
      const openCellUpload = (row, col) => { uploadingCell.value = {row, col}; cellFileInput.value.click(); };
      const handleCellFile = (e) => { const file = e.target.files[0]; if(!file || !uploadingCell.value.row) return; Swal.showLoading(); const r = new FileReader(); r.onload = (ev) => { google.script.run.withSuccessHandler(res => { if(res.success){ const colName = String(uploadingCell.value.col).toUpperCase(); if (colName === 'INFO CLIENTE' || colName === 'REQUISITOR') { const currentVal = uploadingCell.value.row[uploadingCell.value.col] || ''; uploadingCell.value.row[uploadingCell.value.col] = currentVal ? currentVal + '\n' + res.fileUrl : res.fileUrl; } else { uploadingCell.value.row[uploadingCell.value.col] = res.fileUrl; } saveRow(uploadingCell.value.row); } else Swal.fire('Error', res.message, 'error'); e.target.value = null; }).uploadFileToDrive(ev.target.result, file.type, file.name); }; r.readAsDataURL(file); };
      const addResponsable = (n) => { selectedResponsables.value.push(n); staffSearch.value=''; };
      const openFileDialog = () => fileInput.value.click();
      const handleFileSelect = (e) => { const file = e.target.files[0]; if(!file) return; isUploadingFile.value=true; const r = new FileReader(); r.onload=(ev)=>google.script.run.withSuccessHandler(res=>{isUploadingFile.value=false;if(res.success){uploadSuccess.value=true; if(currentView.value === 'PPC_DINAMICO') dynamicPpc.value.archivoUrl=res.fileUrl; else ppcData.value.archivoUrl=res.fileUrl; Swal.fire('Archivo Subido','','success');}}).uploadFileToDrive(ev.target.result,file.type,file.name); r.readAsDataURL(file); };
      const promptExtraData = () => { if(!ppcData.value.concepto || !selectedResponsables.value.length) return Swal.fire('Faltan datos básicos','','warning'); extraData.value = { restricciones: '', prioridades: '', riesgos: '', fechaRespuesta: '', clasificacion: '' }; showExtraModal.value = true; };
      const confirmAddToQueue = () => { const item = JSON.parse(JSON.stringify(ppcData.value)); item.responsable = selectedResponsables.value.join(','); item.restricciones = extraData.value.restricciones; item.prioridades = extraData.value.prioridades; item.riesgos = extraData.value.riesgos; item.clasificacion = extraData.value.clasificacion; if(currentPpcProject.value) { const tag = `[PROY: ${currentPpcProject.value.name}]`; item.comentarios = (item.comentarios ? item.comentarios + ' ' : '') + tag; } let fResp = extraData.value.fechaRespuesta; if(fResp) { const parts = fResp.split('-'); if(parts.length === 3) fResp = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; } item.fechaRespuesta = fResp; item.fechaAlta = new Date().toISOString(); activityQueue.value.push(item); ppcData.value.concepto=''; ppcData.value.horas=''; ppcData.value.comentarios=''; ppcData.value.comentariosPrevios=''; selectedResponsables.value=[]; uploadSuccess.value=false; showExtraModal.value = false; syncQueueToBackend(); };
      const syncQueueToBackend = () => { google.script.run.apiSyncDrafts(JSON.parse(JSON.stringify(activityQueue.value))); };
      const saveDynamicPPC = () => { if(!dynamicPpc.value.especialidad || !dynamicPpc.value.concepto || !selectedResponsables.value.length) return Swal.fire('Faltan datos','','warning'); isSubmitting.value = true; let fResp = dynamicPpc.value.fechaFin; if(fResp) { const parts = fResp.split('-'); if(parts.length === 3) fResp = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; } let finalComs = dynamicPpc.value.comentarios || ''; if(currentPpcProject.value) { finalComs = (finalComs ? finalComs + ' ' : '') + `[PROY: ${currentPpcProject.value.name}]`; } const payload = { especialidad: dynamicPpc.value.especialidad, concepto: dynamicPpc.value.concepto, responsable: selectedResponsables.value.join(','), clasificacion: dynamicPpc.value.clasificacion, riesgos: dynamicPpc.value.riesgos, prioridad: dynamicPpc.value.prioridad, fechaRespuesta: fResp, archivoUrl: dynamicPpc.value.archivoUrl, comentarios: finalComs, horas: '', cumplimiento: 'NO' }; google.script.run.withSuccessHandler(res => { isSubmitting.value = false; if(res.success){ Swal.fire('Registro Guardado','Enviado a PPC y Tracker','success'); dynamicPpc.value = { especialidad: '', clasificacion: 'A', concepto: '', riesgos: 'BAJO', prioridad: 'MEDIA', fechaFin: '', comentarios: '', archivoUrl: '' }; selectedResponsables.value = []; uploadSuccess.value = false; } else { Swal.fire('Error', res.message, 'error'); } }).withFailureHandler(handleErr).apiSavePPCData([payload]); };
      const submitBatch = () => { isSubmitting.value=true; google.script.run.withSuccessHandler(res => { isSubmitting.value=false; if(res.success){ Swal.fire('Guardado','','success'); google.script.run.withSuccessHandler(r => { if(r.success) ppcExistingData.value = r.data; }).apiFetchPPCData(); } else Swal.fire('Error',res.message,'error'); }).withFailureHandler(handleErr).apiSavePPCData(JSON.parse(JSON.stringify(activityQueue.value))); };
      const clearQueue = () => { Swal.fire({ title: '¿Limpiar tabla?', icon: 'warning', showCancelButton: true, confirmButtonText: 'Sí' }).then((result) => { if (result.isConfirmed) { activityQueue.value = []; google.script.run.apiClearDrafts(); } }); };
      const toIsoDate = (val) => { if (!val) return ''; const parts = String(val).split('/'); if (parts.length === 3) { let y = parts[2]; if (y.length === 2) y = '20' + y; return `${y}-${parts[1]}-${parts[0]}`; } return ''; };
      const formatDisplayDate = (val) => { if(!val) return ''; if(String(val).match(/^\d{1,2}\/\d{1,2}\/\d{2}$/)) return val; if(String(val).match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) return val.replace(/\/(\d{4})$/, (m, y) => "/" + y.slice(-2)); return val; };
      const updateDateFromPicker = (e, row, h) => { const val = e.target.value; if (!val) { row[h] = ''; return; } const parts = val.split('-'); if (parts.length === 3) row[h] = `${parts[2]}/${parts[1]}/${parts[0].slice(-2)}`; };
      
      return { isLoggedIn, loginPass, loginUser, loggingIn, doLogin, logout, currentUser, currentView, config, staffTracker, weeklyPlanData, searchQuery, goHome, selectDept, openStaffTracker, reloadStaffTracker, goBackToDept, saveRow, addNewRow, openModule, filteredStaff, getTrafficStyle, ppcData, isSubmitting, selectedResponsables, staffSearch, filteredDirectory, addResponsable, promptExtraData, confirmAddToQueue, activityQueue, submitBatch, clearQueue, pageTitle, openFileDialog, handleFileSelect, fileInput, isUploadingFile, uploadSuccess, closeIframe, showExtraModal, extraData, priorityOpts, riskOpts, salesStaff, cellFileInput, openCellUpload, handleCellFile, toIsoDate, updateDateFromPicker, formatDisplayDate, isMediaColumn, getColumnStyle, getHeaderLabel, isCol, deptStats, currentDeptData, currentModuleId, currentDept, ppcExistingData, dynamicPpc, saveDynamicPPC, getFechaRespuestaStyle, syncQueueToBackend, isCompact, toggleSidebar, loadWeeklyPlan, weeklyStats, savePPCV3Row, selectedWeek, availableWeeks, filteredWeeklyData, projectCards, activeProjectsList, projectSubFolders, openFolderContent, toggleExpand, showPpcSelectorModal, openPpcProjectSelector, ppcMode, selectPpcProject, createNewProject, newProject, currentPpcProject, loadCascadeTree, showSubProjectModal, currentTargetSite, newSubProject, openAddSubProject, createSubProject, openProjectTask, projectTasks, refreshProjectTasks, addNewProjectTask, saveProjectRow, 
      ecgData, loadEcgData, renderEcgCharts, toInitials, showPassword, availableSpecialties, filterSpecialty, filterCompliance, kpiData, loadKPIData };
    }
  });
  app.config.errorHandler = (err) => { console.error(err); Swal.fire({ icon: 'error', title: 'Error de Renderizado', text: 'Ocurrió un error visual: ' + err.message }); };
  app.mount('#app');
</script>
</body>
</html>